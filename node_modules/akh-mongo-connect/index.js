`use strict`
const mongoose = require('mongoose');
const bodyParser = require('body-parser');

module.exports = (app, config) => {
    app.use(bodyParser.urlencoded({ extended: true }))

    // parse requests of content-type - application/json
    app.use(bodyParser.json())

    app.use(function(req, res, next) {
        res.header("Access-Control-Allow-Origin", config.allowedHost);
        res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, X-AccessKey"); 

        if(req.header('X-AccessKey') != config.accessKey){
            return res.status(401).send({
                message: "Unautherised access"
            })
        }
        next();
    });

    mongoose.Promise = global.Promise;

    // Connecting to the database
    mongoose.connect(config.DBurl, {
        useNewUrlParser: true
    }).then(() => {
        console.log("Successfully connected to the database");    
    }).catch(err => {
        console.log('Could not connect to the database. Exiting now...');
        process.exit();
    });

    const interface = require('./api-interface');
    //Add Data to  collection
    app.post('/api-console/:collection_name', interface.create);
    app.put('/api-console/:collection_name/:id', interface.update);
    app.get('/api-console/:collection_name', interface.findAll);
    app.get('/api-console/:collection_name/:id', interface.findOne);
    app.delete('/api-console/:collection_name/:id', interface.delete);
    return app;
}